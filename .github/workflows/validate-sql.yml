name: Validate SQL Queries

on:
  push:
    branches: [ "**" ]

jobs:
  validate-sql:
    runs-on: ubuntu-latest
    env:
      API_URL: "https://pg-advisor.itatmisis.ru/api/validate-query"
      DB_NAME: "demo"
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install requests
        sudo apt-get install -y jq
        
    - name: Validate SQL files
      run: |
        find . -name '*.sql' | while read -r sqlfile; do
          echo "Validating $sqlfile"
          
          sql_content=$(cat "$sqlfile" | jq -Rs . | sed 's/^"//;s/"$//')
          json_payload="{\"query\": \"$sql_content\", \"dbname\": \"$DB_NAME\"}"
          
          response=$(curl -s -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -d "$json_payload")
          
          overall_valid=$(echo "$response" | jq -r '.overall_valid')
          
          if [ "$overall_valid" = "true" ]; then
            echo "✅ Validation passed for $sqlfile"
          else
            echo "❌ Validation failed for $sqlfile"
            echo "$response" | jq .
            exit 1
          fi
        done
